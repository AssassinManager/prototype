<?php

require('target_targets.inc');
require('target_rules.inc');


function target_rules_action_info() {
	return array(
		'am_ranking' =>_update_ranking_action(),
		'am_targeting' =>_update_targets_action(),
		);
}

/**
 * User targeting handlers
 */
function target_kill() {

	global $user;
	$user = user_load($user->uid);

	if (!isset($user->field_current_target['und']) || 
		count($user->field_current_target['und']) < 1) {
		drupal_set_message("No assigned target!", 'warning');
		return;
	}

	$kills = _target_unconfirmed_kills($user->uid);
	if (count($kills) > 0) {
		drupal_set_message("Target still pending elimination confirmation!", 'warning');
		return;
	}

	$target_uid = $user->field_current_target['und'][0]['target_id'];
    _target_create_kill($user->uid, $target_uid);
}

function target_deny() {
	global $user;

	$deathWarrants = _target_death_warrant($user->uid);
	if (count($deathWarrants) < 1) {
		drupal_set_message("Cannot find your death warrant...", 'warning');
		return;
	}

	$user = user_load($user->uid);
	$target_uid = $user->field_current_target['und'][0]['target_id'];

	module_load_include('module', 'messaging', 'messaging');
	messaging_deny_kill($target_uid, $user->uid);

	drupal_set_message("Got that, the organizer was added to the loop to help set this straight.");
}

function target_accept() {
	global $user;

	$deathWarrants = _target_death_warrant($user->uid);
	if (count($deathWarrants) < 1) {
		drupal_set_message("Cannot find your death warrant...", 'warning');
		return;
	}

	$kill = node_load($deathWarrants[0]);
	$kill->field_confirmed['und'][0]['value'] = 1;
	node_save($kill);

	// Assigning new target
	$user = user_load($user->uid);
	unset($user->field_current_target['und']);
}

/**
 * Create kill node
 */
function _target_create_kill($assassin_uid, $target_uid) {
	$node = new stdclass();
    $node->type = 'kill';
    node_object_prepare($node);

    $node->language = 'und';

    $node->title = 'Kill-' . $assassin_uid . "vs" . $target_uid;
    $node->field_confirmed['und'][0]['value'] = 0;

    $node->field_target['und'][0]['target_id'] = $target_uid;
    $node->field_assassin['und'][0]['target_id'] = $assassin_uid;

    node_save($node);
}

/**
 * Utilities
 */
function _target_confirmed_kills($uid) {
	$query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'node')
            ->entityCondition('bundle', 'kill')
            ->propertyCondition('status', 1)
            ->propertyCondition('uid', $uid)
            ->fieldCondition('field_confirmed', 'value', array(1));

    $kills = $query->execute();

    if (count($kills) < 1) return array();
    return array_keys($kills['node']);
}
function _target_unconfirmed_kills($uid) {
	$query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'node')
            ->entityCondition('bundle', 'kill')
            ->propertyCondition('status', 1)
            ->propertyCondition('uid', $uid)
            ->fieldCondition('field_confirmed', 'value', array(0));

    $kills = $query->execute();

    if (count($kills) < 1) return array();
    return array_keys($kills['node']);
}
function _target_death_warrant($uid) {
	$query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'node')
            ->entityCondition('bundle', 'kill')
            ->propertyCondition('status', 1)
            ->fieldCondition('field_target', 'target_id', array($uid));

    $warrant = $query->execute();

    if (count($warrant) < 1) return array();
    return array_keys($warrant['node']);
}