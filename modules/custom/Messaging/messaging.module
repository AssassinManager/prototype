<?php

require('messaging_notifier.inc');

require('messaging_email_action.inc');
require('messaging_recipients.inc');
require('messaging_rule.inc');
require('messaging_read.inc');

require('messaging_sms_action.inc');
require('messaging_twilio.inc');


function messaging_rules_action_info() {
	return array(
		'am_mail' =>_create_email_action(),
		'am_sms' => _create_sms_action(),
		);
}


/*
 * Send message Notifier
 */
function messaging_send_to_notifier($message) {
	$recipients = _get_recipients_in($message);
	if (_notifier_get_num_recipients($message) > 2) {

	}
}

/*
 * Send message API
 */
function _messaging_send_message($subject, $body, $to) {
	$node = new stdclass();
    $node->type = 'message';
    node_object_prepare($node);

    $node->language = 'und';

    $node->title = $subject;
    $node->field_body['und'][0]['value'] = $body;
    $node->field_body['und'][0]['safe_value'] = "<p>" . $body ."<p>";
    $node->field_body['und'][0]['format'] = 'filtered_html';

    $node->field_send_sms['und'][0]['value'] = 0;
    $node->field_send_email['und'][0]['value'] = 0;

    $node->field_recipients['und'] = $to;

    node_save($node);
}

function _messaging_get_organizers_uid() {
	$uids = array();

	$role_result = db_select('role', 'r')
					->fields('r', array('rid'))
				    ->condition('name', 'Organizer', '=')
				    ->range(0,1)
				    ->execute()
				    ->fetchAssoc();

	$rid = $role_result['rid'];

	$user_query = db_select('users_roles', 'ur');
	$user_query->fields('ur', array('uid'));
	$user_query->condition('rid', $rid, '=');
	$result = $user_query->execute();

	while($record = $result->fetchAssoc()) {
		array_push($uids, $record['uid']);
    }

	return $uids;
}

function messaging_send_message_to_player($subject, $body, $to) {
	
    $recipients = "";
    _messaging_send_message($subject, $body, $from, $recipients);
}

function messaging_send_message_to_organizers($subject, $body) {
	
    $recipients_uids = _messaging_get_organizers_uid();
    $recipients = array();
    foreach ($recipients_uids as $uid) {
    	array_push($recipients, array('target_id' => $uid));
    }
    _messaging_send_message($subject, $body, $recipients);
}

/*
 * Messaging Utilities
 */
function _messaging_get_recipients($message) {
  $recipients = _get_recipients($message);
  foreach ($recipients as $recipient) {
    array_push($recipients, $user['target_id']);
  }
  return $recipients;
}
function _messaging_get_reads($message) {
  $reads = array();
  foreach ($message->field_read_by['und'] as $user) {
    array_push($reads, $user['target_id']);
  }
  return $reads;
}
function _messaging_get_emails($users) {
    $emails = array();
    foreach ($users as $user) {
        if (!isset($user->mail)) continue;
        array_push($emails, str_replace(array("\r", "\n"), '', $user->mail));
    }
    return $emails;
}
function _messaging_get_phones($users) {
    $phones = array();
    foreach ($users as $user) {
        if (!isset($user->field_phone['und'])) continue;
        array_push($phones, $user->field_phone['und'][0]['value']);
    }
    return $phones;
}