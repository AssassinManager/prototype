<?php

require("game_table.inc");

/**
 * Implements hook_user_view_alter
 */
function game_node_view_alter(&$build) {

  if ($build['#bundle'] != 'game') return;
  drupal_alter('am_custom_game', $build);

  $build['game_table_form'] = drupal_get_form('_game_table_form');
  $build['game_page_time'] = game_page_time($build);

  unset($build['field_time']);
}

function game_page_time($build) {

  $game = $build['#node'];
  $status = "na";

  $start_time = $game->field_time['und'][0]['value'];
  $end_time = $game->field_time['und'][0]['value2'];

  $start_time = strtotime($start_time);
  $end_time = strtotime($end_time);

  if ($end_time < time()) { 
    return $form['game_page_time'] = array(
                                            '#type' => 'item',
                                            '#title' => t('Game Time:'),
                                            '#markup' => 'Game is over.',
                                          );
  }

  ////////////////////////////////////////////////

  $duration = $end_time-$start_time;
  if ($duration > 604800) { // 1 Week
    $duration = $duration / 604800;
    $duration = round($duration) . ' week game - ';
  } 
  else { // Days
    $duration = $duration / 86400;
    $duration = round($duration) . ' day game - ';
  }

  if ($start_time > time()) {
    $interval = $start_time - time();
    if ($interval > 86400) { // 1 Day
      $time = $interval - 86400;
      $status = 'Game starts in ' . $time . ' days.';
    }
    else if ($interval > 3600) { // 1 Hour
      $status = 'Game starts in ' . date("H", $interval) . ' hours';
      if (date("i", $interval) > 0) $status = $status . ' and .' . date("i", $interval) . ' minutes';
      $status = $status . '.';
    }
    else if ($interval > 60) { // 1 Minute
      $status = 'Game starts in ' . date("i", $interval) . ' minutes.';
    }
    else {
      $status = 'Game starts in ' . date("s", $interval) . ' seconds.';
    }
  }
  else {
    $interval = $end_time - time();
    if ($interval > 86400) { // 1 Day
      $time = $interval / 86400;
      $status = floor($time) . ' days left in game.';
    }
    else if ($interval > 3600) { // 1 Hour
      $status = date("H", $interval) . ' hours';
      if (date("i", $interval) > 0) $status = $status . ' and .' . date("i", $interval) . ' minutes';
      $status = $status . ' left in game.';
    }
    else if ($interval > 60) { // 1 Minute
      $status = date("i", $interval) . ' minutes left in game.';
    }
    else {
      $status = date("s", $interval) . ' seconds left in game!';
    }
  }

  return $form['game_page_time'] = array(
                '#type' => 'item',
                '#title' => t('Game Time:'),
                '#markup' => $duration . $status,
            );
}

/*
 * Example of the connector
 */
/*
function game_am_custom_game_alter(&$data) {
  $data['_profile_form'] = drupal_get_form('_profile_form');
}

function _profile_form($form, &$form_state) {
  $form['profile'] = array(
                '#type' => 'button',
                '#name' => 'profile',
                '#value' => t('profile'),
                '#ajax'  => array('callback' => '_do_stuff'),
            );

  return $form;
}

function _do_stuff() {
  echo 1;
}
*/